@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

title SCP - Container Diagram (Level 2) - Kubernetes Topology
left to right direction

' Users
Person(agent, "Field Agent", "Mobile App")
Person(web_user, "Web User", "Admin/Gov/NGO")

System_Boundary(k8s_cluster, "SCP Kubernetes Cluster") {
    
    ' Ingress
    Container(ingress, "Ingress Controller", "Nginx/Envoy", "SSL Termination, Routing, Rate Limiting")

    ' Apps
    Container(web_spa, "Web Admin Portal", "React/Angular", "SPA serving the dashboard UI.")
    Container(mobile_app, "Field Mobile App", "Flutter/React Native", "Offline-first Android/iOS app.")

    ' Core Services
    Container(idp, "Identity Provider", "Keycloak", "OIDC/OAuth2 Auth Service.\nManages Users & Roles.")
    
    Container(monolith, "SCP Modular Monolith", ".NET Core Deployment", "The main application logic.\nContains all Modules (Security, Core, Verticals).\nStateless & Scalable.")
    
    Container(job_worker, "Background Worker", ".NET Core Worker", "Async tasks: Reports, Email sending, Data referencing.")

    ' Data Stores
    ContainerDb(db_read, "Read Replica", "PostgreSQL", " optimized for reporting queries.")
    ContainerDb(db_write, "Primary DB", "PostgreSQL", "Transactional data (Tenants, Persons, Cases).")
    ContainerDb(redis, "Distributed Cache", "Redis", "Session store, lookups, policy cache.")
    ContainerDb(obj_store, "Object Storage", "MinIO / S3", "Photos, Documents, Attachments.")
    
    ' Monitoring
    Container(prom, "Observability", "Prometheus/Grafana", "Metrics & Logs.")
}

System_Ext(ext_api, "External APIs", "Payment, SMS, Gov ID")

' Flows
Rel(agent, ingress, "API Calls (HTTPS)")
Rel(web_user, ingress, "HTTPS/WSS")

Rel(ingress, web_spa, "Routes to")
Rel(ingress, monolith, "Proxies API reqs")
Rel(ingress, idp, "Auth Redirects")

Rel(monolith, idp, "Validates Tokens (JWKS)")
Rel(monolith, db_write, "Reads/Writes (EF Core)")
Rel(monolith, db_read, "Reads (Reporting)")
Rel(monolith, redis, "Caches Hot Data")
Rel(monolith, obj_store, "Uploads/Downloads")

Rel(monolith, job_worker, "Enqueues Jobs (RabbitMQ/Redis)")
Rel(job_worker, db_write, "Updates Status")

Rel(monolith, ext_api, "Calls External APIs")

@enduml
