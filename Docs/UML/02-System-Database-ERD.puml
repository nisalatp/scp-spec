@startuml
title SCP - System Database Schema (ERD)
left to right direction
!theme plain
hide circle

entity "tenants" {
  *id : uuid <<PK>>
  --
  name : varchar
  config_json : jsonb
  created_at : timestamp
}

entity "users" {
  *id : uuid <<PK>>
  --
  tenant_id : uuid <<FK>>
  username : varchar
  password_hash : varchar
  role_flags : int
}

entity "persons" {
  *id : uuid <<PK>>
  --
  tenant_id : uuid <<FK>>
  household_id : uuid <<FK>>
  full_name : varchar
  dob : date
  gender : varchar(1)
  status : varchar(20)
  consent_json : jsonb
  meta_json : jsonb
}

entity "households" {
  *id : uuid <<PK>>
  --
  tenant_id : uuid <<FK>>
  geo_node_id : uuid <<FK>>
  address_text : text
  leader_person_id : uuid <<FK>>
}

entity "geo_nodes" {
  *id : uuid <<PK>>
  --
  parent_id : uuid <<FK>>
  name : varchar
  type : varchar
  boundary_wkt : text
}

entity "cases" {
  *id : uuid <<PK>>
  --
  tenant_id : uuid <<FK>>
  program_id : uuid <<FK>>
  beneficiary_person_id : uuid <<FK>>
  status : varchar
  owner_user_id : uuid <<FK>>
  created_at : timestamp
}

entity "integrations" {
  *id : uuid <<PK>>
  --
  tenant_id : uuid <<FK>>
  partner_name : varchar
  auth_client_id : varchar
  status : varchar
  scopes : jsonb
}

entity "audit_logs" {
  *id : bigint <<PK>>
  --
  tenant_id : uuid
  user_id : uuid
  integration_id : uuid <<FK>>
  action : varchar
  entity_id : uuid
  changes_json : jsonb
  timestamp : timestamp
}

' Relations
tenants ||..|| users
tenants ||..|| persons
tenants ||..|| households
tenants ||..|| integrations

integrations |o..o{ audit_logs

households |o..|{ persons
geo_nodes ||..|{ households
geo_nodes |o..|{ geo_nodes

cases }o..|| persons
cases }o..|| users

users ||..o{ audit_logs

@enduml
