@startuml
title SCP - Operations: Offline Sync & Conflict Resolution (Sequence)
autoactivate on

actor "Field Agent" as Agent
participant "Mobile App\n(Offline Store)" as App
participant "Sync Engine" as Sync
participant "Conflict Resolver" as Resolver
participant "Primary DB" as DB

note over Agent: Agent updates Person A's\nPhone Number while offline.

Agent -> App: UpdatePerson(PersonID, NewPhone)
    App -> App: StoreChange(Delta, Timestamp_T1)
return Success

note over Agent: Later, Agent goes online.

Agent -> App: Trigger Sync
    App -> Sync: PushChanges(DeltaList)
        
        loop For Each Delta
            Sync -> DB: GetCurrentVersion(PersonID)
            return CurrentState (Timestamp_T2)
            
            note right of Sync
            Check T1 vs T2.
            If T2 > T1, we have a conflict.
            end note
            
            Sync -> Resolver: Resolve(Delta, CurrentState)
                
                alt Auto-Resolve (Last Write Wins / Policy)
                  Resolver -> DB: ApplyUpdate()
                  return Success
                  
                else Manual Intervention Required
                  Resolver -> DB: FlagConflict(Delta)
                  return Flagged
                end
                
            return ResolutionResult
        end
        
    return SyncReport(Success, Conflicts)
return Display Report

newpage SCP - Integrations: Webhook Event Delivery (Sequence)

participant "Core Monolith" as Core
participant "Event Bus" as Bus
participant "Integration Svc" as Integ
participant "External Partner" as Partner

Core -> Bus: Publish(CaseApprovedEvent)

Bus -> Integ: Consume(CaseApprovedEvent)
    
    Integ -> Integ: LookupSubscriptions(Event.Type)
    return List<Webhooks>
    
    loop For Each Webhook
        Integ -> Integ: CheckPrivacy(Event.Payload, Webhook.Scope)
        
        alt Data Allowed
            Integ -> Partner: POST /webhook (Payload)
            activate Partner
            return 200 OK
            deactivate Partner
        else Data Restricted
            Integ -> Integ: Log(Skipped - Privacy)
        end
    end

@enduml
